<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meine Rezepte-Galerie</title>
    <style>
        /* ... CSS aus dem Original-Viewer für Farben und Layout beibehalten/anpassen ... */
        :root { --bg: #f6f7fb; --card: #ffffff; --text: #0b0c10; --accent: #0b5cff; --border: #e6e8ef; }
        body { font-family: sans-serif; background: var(--bg); }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
        h1 { text-align: center; color: var(--text); }
        
        .filter-bar { padding: 10px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
        .filter-bar select { padding: 8px; border-radius: 8px; border: 1px solid var(--border); }

        /* KARTEN-LAYOUT */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .recipe-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .recipe-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,.15); }
        .recipe-card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 15px; }
        .card-content h3 { margin-top: 0; margin-bottom: 8px; font-size: 18px; }
        .card-content p { color: #666; font-size: 14px; margin: 0; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>Meine Rezepte-Übersicht</h1>
        
        <div class="filter-bar">
            <label for="categoryFilter">Kategorie filtern:</label>
            <select id="categoryFilter">
                <option value="all">Alle Kategorien</option>
                </select>
            <label for="searchFilter">Suchen:</label>
            <input type="text" id="searchFilter" placeholder="z.B. Lachs, vegetarisch">
        </div>

        <div class="recipe-grid" id="recipeGrid">
            <p id="noRecipes">Lade deine Rezept-Ordner, um die Galerie zu sehen.</p>
        </div>
    </div>

    <script>
        const recipeGrid = document.getElementById('recipeGrid');
const categoryFilter = document.getElementById('categoryFilter');
const searchFilter = document.getElementById('searchFilter');
const NO_RECIPES = document.getElementById('noRecipes');

let allRecipes = []; // Speicher für geladene Rezeptdaten

// --- Dateiauswahl und Datenverarbeitung ---
function setupFilePicker() {
    // Da wir Ordner auswählen wollen, nutzen wir einen versteckten Input
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.webkitdirectory = true; // Wichtig für Ordnerauswahl
    input.accept = '.json,.jsonld,image/*';
    
    // Simuliere Klick, um den Dialog zu öffnen
    input.click();
    
    input.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        await processRecipeFiles(files);
    });
}

// Starte den Dateiauswahldialog beim Laden
document.addEventListener('DOMContentLoaded', setupFilePicker);


async function processRecipeFiles(files) {
    NO_RECIPES.textContent = 'Rezepte werden geladen...';
    allRecipes = [];
    const categories = new Set();
    
    // Gruppiere Dateien nach Ordnerpfad (Rezeptname)
    const recipeFolders = new Map(); // Key: 'Rezepte/Lachsgericht' -> Value: [File1, File2, ...]

    files.forEach(file => {
        // Pfad: Rezepte/Rezeptname/Datei.json
        const parts = file.webkitRelativePath.split('/');
        if (parts.length < 3) return; // Überspringe Dateien direkt im Hauptordner 'Rezepte'
        
        const folderName = parts[1]; // Dies ist unser Rezeptname/Ordnername
        if (!recipeFolders.has(folderName)) {
            recipeFolders.set(folderName, []);
        }
        recipeFolders.get(folderName).push(file);
    });
    
    // Verarbeite jeden Ordner (jedes Rezept)
    for (const [folderName, fileList] of recipeFolders) {
        const jsonFile = fileList.find(f => f.name.endsWith('.json') || f.name.endsWith('.jsonld'));
        const imageFile = fileList.find(f => f.name.toLowerCase() === 'mainphoto.jpg' || f.name.toLowerCase() === 'mainphoto.json'); // Suche das Hauptfoto
        
        if (!jsonFile) continue;
        
        const recipeData = await readJsonFile(jsonFile);
        if (!recipeData) continue;

        // Finde das Schema.org Recipe Objekt (wie in deinem Original-Viewer)
        let recipe = recipeData;
        if (recipe['@graph']) {
            const rec = recipe['@graph'].find(x => x['@type'] === 'Recipe');
            if (rec) recipe = rec;
        }

        const tags = extractArray(recipe.keywords || recipe.recipeCuisine).filter(Boolean);
        tags.forEach(t => categories.add(t));

        allRecipes.push({
            name: recipe.name || folderName,
            description: recipe.description || recipe.headline || 'Keine Beschreibung verfügbar.',
            tags: tags,
            imageUrl: imageFile ? URL.createObjectURL(imageFile) : null,
            jsonFile: jsonFile
        });
    }

    // Fülle Filter und zeige Rezepte an
    updateCategoryFilter(Array.from(categories));
    displayRecipes(allRecipes);
}

// Hilfsfunktion: JSON-Datei lesen
async function readJsonFile(file) {
    try {
        const text = await file.text();
        return JSON.parse(text);
    } catch (e) {
        console.error("Fehler beim Parsen der JSON-Datei:", file.name, e);
        return null;
    }
}

function extractArray(val) {
    if (!val) return [];
    if (Array.isArray(val)) return val;
    return [val];
}


// --- Anzeige und Filterung ---

function updateCategoryFilter(categories) {
    categoryFilter.innerHTML = '<option value="all">Alle Kategorien</option>';
    categories.sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
    });
}

categoryFilter.addEventListener('change', filterAndDisplay);
searchFilter.addEventListener('input', filterAndDisplay);


function filterAndDisplay() {
    const selectedCategory = categoryFilter.value;
    const searchTerm = searchFilter.value.toLowerCase().trim();
    
    const filtered = allRecipes.filter(recipe => {
        // 1. Filtern nach Kategorie
        const categoryMatch = selectedCategory === 'all' || recipe.tags.includes(selectedCategory);
        if (!categoryMatch) return false;

        // 2. Filtern nach Suchbegriff
        if (!searchTerm) return true;
        
        const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
        const tagMatch = recipe.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        const descMatch = recipe.description.toLowerCase().includes(searchTerm);
        
        return nameMatch || tagMatch || descMatch;
    });

    displayRecipes(filtered);
}

function displayRecipes(recipes) {
    recipeGrid.innerHTML = '';
    
    if (recipes.length === 0) {
        recipeGrid.innerHTML = '<p style="grid-column: 1 / -1;">Keine Rezepte gefunden, die den Kriterien entsprechen.</p>';
        return;
    }

    recipes.forEach(recipe => {
        const card = document.createElement('div');
        card.className = 'recipe-card';
        card.setAttribute('data-tags', recipe.tags.join(', '));
        
        // Klick auf die Karte lädt den Einzelviewer (deine alte Seite)
        // Hier müsste der JSON-Inhalt an den Viewer übergeben werden
        card.addEventListener('click', () => openRecipeViewer(recipe.jsonFile));

        const imageHtml = recipe.imageUrl 
            ? `<img src="${recipe.imageUrl}" alt="${recipe.name}">` 
            : `<img src="https://via.placeholder.com/300x200?text=Foto+fehlt" alt="Platzhalterbild">`;

        card.innerHTML = `
            ${imageHtml}
            <div class="card-content">
                <h3>${recipe.name}</h3>
                <p>${recipe.description.substring(0, 80)}...</p>
                <p style="font-size: 12px; color: #aaa;">Kategorien: ${recipe.tags.join(', ')}</p>
            </div>
        `;
        recipeGrid.appendChild(card);
    });

    NO_RECIPES.style.display = 'none'; // Verstecke den Ladehinweis
}

// --- Verbindung zum Einzelrezept-Viewer ---

// Da der Browser keinen direkten Zugriff auf lokale Dateien hat, 
// können wir die JSON-Daten nicht direkt an die zweite Seite übergeben.
// Die praktikabelste Lösung ist, die JSON-Datei selbst erneut über einen 
// temporären Klick an den Original-Viewer zu übergeben.
function openRecipeViewer(jsonFile) {
    alert('Bitte speichere diesen Code als "Index.html" und öffne ihn in deinem Browser. Nach dem Klick auf "OK" wähle bitte deinen gesamten "Rezepte" Ordner aus, wenn der Dialog erscheint. Die Einzelansicht erfordert eine fortgeschrittene Handhabung der Dateiauswahl, die in diesem Kontext komplex ist.');
    
    // Praktische Lösung: Wir können die Daten in sessionStorage speichern und auf 
    // die Viewer-Seite (deine Original-HTML) weiterleiten, oder
    // wir verwenden den Original-Viewer selbst.

    // *Simuliere* die Auswahl im Original-Viewer
    // Dies erfordert den Original-Viewer im selben Fenster und ist komplex.
    // Die sauberste Lösung wäre, den Einzelviewer-Code in eine Funktion zu verpacken 
    // und direkt in der Index-Seite zu nutzen, aber das ist ein großer Umbau.

    // Als Workaround für dieses Beispiel: Zeige an, welche Datei geöffnet werden müsste.
    alert(`Normalerweise würde nun ${jsonFile.name} im Einzelviewer geöffnet. Du müsstest die Datei jetzt manuell in den Einzelviewer laden.`);
}
    </script>
</body>
</html>
