<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meine Rezepte-Galerie</title>
    <style>
        :root { --bg: #f6f7fb; --card: #ffffff; --text: #0b0c10; --accent: #0b5cff; --border: #e6e8ef; }
        body { font-family: sans-serif; background: var(--bg); }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
        h1 { text-align: center; color: var(--text); }
        
        .filter-bar { padding: 10px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filter-bar select, .filter-bar input[type="text"] { padding: 8px; border-radius: 8px; border: 1px solid var(--border); }
        .filter-bar button { padding: 10px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; }

        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .recipe-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .recipe-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,.15); }
        .recipe-card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 15px; }
        .card-content h3 { margin-top: 0; margin-bottom: 8px; font-size: 18px; }
        .card-content p { color: #666; font-size: 14px; margin: 0; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>Meine Rezepte-√úbersicht</h1>
        
        <div class="filter-bar">
            <button id="uploadButton">üìÇ Rezepte-Ordner hochladen</button>

            <label for="categoryFilter">Kategorie filtern:</label>
            <select id="categoryFilter">
                <option value="all">Alle Kategorien</option>
                </select>
            <label for="searchFilter">Suchen:</label>
            <input type="text" id="searchFilter" placeholder="z.B. Lachs, vegetarisch">
        </div>

        <div class="recipe-grid" id="recipeGrid">
            <p id="noRecipes">Bitte klicke auf "Rezepte-Ordner hochladen", um deine Galerie zu sehen.</p>
        </div>
    </div>

    <script>
        const recipeGrid = document.getElementById('recipeGrid');
const categoryFilter = document.getElementById('categoryFilter');
const searchFilter = document.getElementById('searchFilter');
const NO_RECIPES = document.getElementById('noRecipes');
const UPLOAD_BUTTON = document.getElementById('uploadButton'); // Neuer Button

let allRecipes = []; // Speicher f√ºr geladene Rezeptdaten

// --- Dateiauswahl und Datenverarbeitung ---
function setupFilePicker() {
    // Da wir Ordner ausw√§hlen wollen, nutzen wir einen versteckten Input
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.webkitdirectory = true; // Wichtig f√ºr Ordnerauswahl
    input.accept = '.json,.jsonld,image/*';
    
    // Sobald die Dateien ausgew√§hlt sind
    input.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            await processRecipeFiles(files);
        } else {
            NO_RECIPES.textContent = 'Bitte w√§hle deinen Ordner "Rezepte" aus.';
        }
    });

    // √ñffne den Dateiauswahldialog beim Klick
    input.click();
}

// Binde die Funktion an den neuen Button
document.addEventListener('DOMContentLoaded', () => {
    UPLOAD_BUTTON.addEventListener('click', setupFilePicker);
});


async function processRecipeFiles(files) {
    NO_RECIPES.textContent = 'Rezepte werden geladen... Bitte warten...';
    allRecipes = [];
    const categories = new Set();
    
    // Gruppiere Dateien nach Ordnerpfad (Rezeptname)
    const recipeFolders = new Map();

    files.forEach(file => {
        // Beispiel: 'Rezepte/Lachsgericht/datei.json' -> parts[1] ist 'Lachsgericht'
        const parts = file.webkitRelativePath.split('/');
        if (parts.length < 3) return;
        
        const folderName = parts[1];
        if (!recipeFolders.has(folderName)) {
            recipeFolders.set(folderName, []);
        }
        recipeFolders.get(folderName).push(file);
    });
    
    for (const [folderName, fileList] of recipeFolders) {
        const jsonFile = fileList.find(f => f.name.endsWith('.json') || f.name.endsWith('.jsonld'));
        // Suche nach mainphoto.jpg oder einem anderen Bild im Ordner
        const imageFile = fileList.find(f => f.name.toLowerCase() === 'mainphoto.jpg' || f.type.startsWith('image/')); 
        
        if (!jsonFile) continue;
        
        const recipeData = await readJsonFile(jsonFile);
        if (!recipeData) continue;

        let recipe = recipeData;
        if (recipe['@graph']) {
            const rec = recipe['@graph'].find(x => x['@type'] === 'Recipe');
            if (rec) recipe = rec;
        }

        const tags = extractArray(recipe.keywords || recipe.recipeCuisine).filter(Boolean);
        tags.forEach(t => categories.add(t));

        allRecipes.push({
            name: recipe.name || folderName,
            description: recipe.description || recipe.headline || 'Keine Beschreibung verf√ºgbar.',
            tags: tags,
            imageUrl: imageFile ? URL.createObjectURL(imageFile) : null,
            jsonFile: jsonFile
        });
    }

    updateCategoryFilter(Array.from(categories));
    displayRecipes(allRecipes);
    UPLOAD_BUTTON.textContent = 'üìÇ Rezepte-Ordner neu laden'; // Text nach dem Laden √§ndern
}

// Hilfsfunktionen (readJsonFile, extractArray, updateCategoryFilter, filterAndDisplay, displayRecipes, openRecipeViewer) bleiben unver√§ndert. 
// Denken Sie daran, den gesamten alten JavaScript-Code hier einzuf√ºgen, damit alle Funktionen vorhanden sind.


// (Unver√§nderte Hilfsfunktionen von vorher, hier nur als Platzhalter f√ºr die √úbersichtlichkeit)
/*
async function readJsonFile(file) { ... }
function extractArray(val) { ... }
function updateCategoryFilter(categories) { ... }
function filterAndDisplay() { ... }
function displayRecipes(recipes) { ... }
function openRecipeViewer(jsonFile) { ... }
*/

function readJsonFile(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                resolve(JSON.parse(e.target.result));
            } catch (error) {
                console.error("Fehler beim Parsen der JSON-Datei:", file.name, error);
                resolve(null);
            }
        };
        reader.onerror = () => {
            console.error("Fehler beim Lesen der Datei:", file.name);
            resolve(null);
        };
        reader.readAsText(file);
    });
}
function extractArray(val) {
    if (!val) return [];
    if (Array.isArray(val)) return val;
    return [val];
}
function updateCategoryFilter(categories) {
    categoryFilter.innerHTML = '<option value="all">Alle Kategorien</option>';
    categories.sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
    });
}
categoryFilter.addEventListener('change', filterAndDisplay);
searchFilter.addEventListener('input', filterAndDisplay);
function filterAndDisplay() {
    const selectedCategory = categoryFilter.value;
    const searchTerm = searchFilter.value.toLowerCase().trim();
    
    const filtered = allRecipes.filter(recipe => {
        const categoryMatch = selectedCategory === 'all' || recipe.tags.some(tag => tag === selectedCategory);
        if (!categoryMatch) return false;

        if (!searchTerm) return true;
        
        const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
        const tagMatch = recipe.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        const descMatch = recipe.description.toLowerCase().includes(searchTerm);
        
        return nameMatch || tagMatch || descMatch;
    });

    displayRecipes(filtered);
}
function displayRecipes(recipes) {
    recipeGrid.innerHTML = '';
    
    if (recipes.length === 0) {
        recipeGrid.innerHTML = '<p style="grid-column: 1 / -1;">Keine Rezepte gefunden, die den Kriterien entsprechen.</p>';
        return;
    }

    recipes.forEach(recipe => {
        const card = document.createElement('div');
        card.className = 'recipe-card';
        card.setAttribute('data-tags', recipe.tags.join(', '));
        
        card.addEventListener('click', () => openRecipeViewer(recipe.jsonFile));

        const imageHtml = recipe.imageUrl 
            ? `<img src="${recipe.imageUrl}" alt="${recipe.name}">` 
            : `<img src="https://via.placeholder.com/300x200?text=Foto+fehlt" alt="Platzhalterbild">`;

        card.innerHTML = `
            ${imageHtml}
            <div class="card-content">
                <h3>${recipe.name}</h3>
                <p>${recipe.description.substring(0, 80)}${recipe.description.length > 80 ? '...' : ''}</p>
                <p style="font-size: 12px; color: #aaa;">Kategorien: ${recipe.tags.join(', ')}</p>
            </div>
        `;
        recipeGrid.appendChild(card);
    });

    NO_RECIPES.style.display = 'none';
}
function openRecipeViewer(jsonFile) {
    alert(`Normalerweise w√ºrde nun die Datei "${jsonFile.name}" ge√∂ffnet. Da dies im Browser aus Sicherheitsgr√ºnden nicht automatisch geht, m√ºsstest du die Datei jetzt manuell in den Einzelviewer (deine alte HTML-Seite) laden.`);
}
    </script>
</body>
</html>
